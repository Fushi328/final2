{% extends "base.html" %}

{% block title %}Reports & Analytics - Dental Practice Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-chart-line me-2"></i>
                    Reports & Analytics Dashboard
                </h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#dateRangeModal">
                        <i class="fas fa-calendar me-2"></i>
                        Date Range
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportReport()">
                        <i class="fas fa-download me-2"></i>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Patients</h5>
                            <h3>{{ stats.total_patients }}</h3>
                            <small>+12% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Monthly Revenue</h5>
                            <h3>â‚±{{ "{:,.2f}".format(stats.total_revenue_month) }}</h3>
                            <small>+8% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">This Week</h5>
                            <h3>{{ stats.this_week_appointments }}</h3>
                            <small>Appointments scheduled</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-week fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Outstanding</h5>
                            <h3>{{ stats.pending_bills }}</h3>
                            <small>Bills pending payment</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-invoice fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Analytics Row -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-primary"></i>
                        Real-time Appointment Trends
                    </h5>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body">
                    <canvas id="appointmentTrendsChart" height="200"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Today's Bookings</small>
                            <span class="badge bg-info" id="todaysBookings">{{ stats.todays_appointments }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Peak Hour</small>
                            <span class="text-primary fw-bold" id="peakHour">2:00 PM</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Avg. Daily</small>
                            <span class="text-success fw-bold" id="avgDaily">8.5</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-check me-2 text-success"></i>
                        Patient Visits Today
                    </h5>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h2 class="text-success mb-0" id="visitCounter">{{ stats.todays_appointments }}</h2>
                        <small class="text-muted">Patients visited today</small>
                    </div>
                    <canvas id="patientVisitsChart" height="150"></canvas>
                    <div class="mt-3">
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 65%" id="visitProgress"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Goal: 15 visits</small>
                            <small class="text-success" id="visitPercentage">65%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes me-2 text-warning"></i>
                        Inventory Usage
                    </h5>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Dental Gloves</span>
                            <span class="badge bg-warning">Low</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 25%"></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Anesthesia</span>
                            <span class="badge bg-success">Good</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 80%"></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">X-ray Films</span>
                            <span class="badge bg-danger">Critical</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 10%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-outline-warning btn-sm" onclick="viewInventoryDetails()">
                            <i class="fas fa-eye me-1"></i>
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Revenue Trend (Last 12 Months)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Treatment Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="treatmentChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Daily Appointments
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="appointmentsChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-doughnut me-2"></i>
                        Patient Demographics
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="demographicsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Appointments & Recent Activity -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Upcoming Appointments (Next 7 Days)
                    </h5>
                </div>
                <div class="card-body">
                    {% if upcoming_appointments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Patient</th>
                                        <th>Type</th>
                                        <th>Doctor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in upcoming_appointments %}
                                    <tr>
                                        <td>{{ appointment.appointment_date.strftime('%m/%d') }}</td>
                                        <td>{{ appointment.appointment_time.strftime('%I:%M %p') }}</td>
                                        <td>
                                            <a href="{{ url_for('patients_view', id=appointment.patient.id) }}" class="text-decoration-none">
                                                {{ appointment.patient.get_full_name() }}
                                            </a>
                                        </td>
                                        <td>{{ appointment.appointment_type }}</td>
                                        <td>Dr. {{ appointment.staff.get_full_name() }}</td>
                                        <td>
                                            <span class="badge bg-{% if appointment.status == 'Scheduled' %}primary{% elif appointment.status == 'Completed' %}success{% else %}secondary{% endif %}">
                                                {{ appointment.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No upcoming appointments in the next 7 days</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Alerts & Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" role="alert">
                        <strong>{{ stats.low_stock_items }}</strong> inventory items are running low
                        <a href="{{ url_for('inventory_index') }}" class="alert-link">View Details</a>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <strong>{{ stats.pending_bills }}</strong> bills are pending payment
                        <a href="{{ url_for('billing_index', status='Pending') }}" class="alert-link">Review Bills</a>
                    </div>

                    <div class="alert alert-success" role="alert">
                        <strong>{{ stats.todays_appointments }}</strong> appointments scheduled for today
                        <a href="{{ url_for('appointments_index') }}" class="alert-link">View Schedule</a>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Performance Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <h4 class="text-success">85%</h4>
                            <small class="text-muted">Appointment Show Rate</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h4 class="text-info">4.2</h4>
                            <small class="text-muted">Avg. Treatments/Day</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-primary">92%</h4>
                            <small class="text-muted">Patient Satisfaction</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">7.5</h4>
                            <small class="text-muted">Avg. Wait Time (min)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Tables -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        Top Performing Treatments
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Treatment</th>
                                    <th class="text-center">Count</th>
                                    <th class="text-end">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dental Cleaning</td>
                                    <td class="text-center">45</td>
                                    <td class="text-end">â‚±112,500</td>
                                </tr>
                                <tr>
                                    <td>Dental Filling</td>
                                    <td class="text-center">32</td>
                                    <td class="text-end">â‚±112,000</td>
                                </tr>
                                <tr>
                                    <td>Root Canal</td>
                                    <td class="text-center">12</td>
                                    <td class="text-end">â‚±180,000</td>
                                </tr>
                                <tr>
                                    <td>Tooth Extraction</td>
                                    <td class="text-center">18</td>
                                    <td class="text-end">â‚±90,000</td>
                                </tr>
                                <tr>
                                    <td>Crown Placement</td>
                                    <td class="text-center">8</td>
                                    <td class="text-end">â‚±160,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-friends me-2"></i>
                        Staff Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Staff Member</th>
                                    <th class="text-center">Appointments</th>
                                    <th class="text-center">Treatments</th>
                                    <th class="text-end">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dr. Admin User</td>
                                    <td class="text-center">68</td>
                                    <td class="text-center">52</td>
                                    <td class="text-end">â‚±420,000</td>
                                </tr>
                                <tr>
                                    <td>Dr. Sarah Johnson</td>
                                    <td class="text-center">42</td>
                                    <td class="text-center">38</td>
                                    <td class="text-end">â‚±285,000</td>
                                </tr>
                                <tr>
                                    <td>Dr. Michael Chen</td>
                                    <td class="text-center">35</td>
                                    <td class="text-center">29</td>
                                    <td class="text-end">â‚±195,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar me-2"></i>
                    Select Date Range
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dateRangeForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="text" class="form-control datepicker" id="startDate" placeholder="Start date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="text" class="form-control datepicker" id="endDate" placeholder="End date" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Quick Select</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('today')">Today</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('week')">This Week</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('month')">This Month</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('year')">This Year</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyDateRange()">
                    <i class="fas fa-filter me-2"></i>
                    Apply Filter
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
                 <div class="col-md-3">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title mb-0">Today's Appointments</h6>
                                        <h3 class="mb-0" id="todays-appointments">{{ stats.todays_appointments }}</h3>
                                        <small class="opacity-75">Scheduled today</small>
                                    </div>
                                    <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                 <div class="col-md-3">
                        <div class="card text-white bg-info h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title mb-0">Today's Visits</h6>
                                        <h3 class="mb-0" id="today-visits">{{ stats.todays_appointments }}</h3>
                                        <small class="opacity-75">Completed treatments</small>
                                    </div>
                                    <i class="fas fa-user-check fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">Appointment Trends</h6>
                                <div id="appointment-trends">
                                    <!-- Appointment trends will be loaded here -->
                                    <div class="text-muted">Loading appointment trends...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">Inventory Usage</h6>
                                <div id="inventory-usage">
                                    <!-- Inventory usage will be loaded here -->
                                    <div class="text-muted">Loading inventory data...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

// Global chart variables for real-time updates
let appointmentTrendsChart, patientVisitsChart;

function initializeCharts() {
    // Real-time Appointment Trends Chart
    const appointmentTrendsCtx = document.getElementById('appointmentTrendsChart').getContext('2d');
    appointmentTrendsChart = new Chart(appointmentTrendsCtx, {
        type: 'line',
        data: {
            labels: ['8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM'],
            datasets: [{
                label: 'Appointments',
                data: [2, 3, 1, 4, 2, 5, 8, 6, 3, 2],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Patient Visits Chart (Hourly progress)
    const patientVisitsCtx = document.getElementById('patientVisitsChart').getContext('2d');
    patientVisitsChart = new Chart(patientVisitsCtx, {
        type: 'bar',
        data: {
            labels: ['8AM', '10AM', '12PM', '2PM', '4PM', '6PM'],
            datasets: [{
                label: 'Visits',
                data: [2, 5, 3, 4, 1, 0],
                backgroundColor: ['#28a745', '#28a745', '#28a745', '#28a745', '#28a745', '#e9ecef'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 6
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Revenue Trend Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Revenue',
                data: [65000, 59000, 80000, 81000, 56000, 85000, 90000, 75000, 88000, 95000, 70000, 85000],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚±' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Treatment Distribution Chart
    const treatmentCtx = document.getElementById('treatmentChart').getContext('2d');
    new Chart(treatmentCtx, {
        type: 'doughnut',
        data: {
            labels: ['Cleaning', 'Filling', 'Root Canal', 'Extraction', 'Crown', 'Other'],
            datasets: [{
                data: [45, 32, 12, 18, 8, 15],
                backgroundColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#6f42c1',
                    '#20c997'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Daily Appointments Chart
    const appointmentsCtx = document.getElementById('appointmentsChart').getContext('2d');
    new Chart(appointmentsCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Appointments',
                data: [12, 19, 15, 17, 20, 8, 3],
                backgroundColor: '#007bff',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Demographics Chart
    const demographicsCtx = document.getElementById('demographicsChart').getContext('2d');
    new Chart(demographicsCtx, {
        type: 'doughnut',
        data: {
            labels: ['18-30', '31-45', '46-60', '60+'],
            datasets: [{
                data: [25, 35, 30, 10],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function setDateRange(period) {
    const now = new Date();
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');

    endDate.value = now.toISOString().split('T')[0];

    switch(period) {
        case 'today':
            startDate.value = now.toISOString().split('T')[0];
            break;
        case 'week':
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            startDate.value = weekStart.toISOString().split('T')[0];
            break;
        case 'month':
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            startDate.value = monthStart.toISOString().split('T')[0];
            break;
        case 'year':
            const yearStart = new Date(now.getFullYear(), 0, 1);
            startDate.value = yearStart.toISOString().split('T')[0];
            break;
    }
}

function applyDateRange() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert('Start date cannot be after end date.');
        return;
    }

    // In a real application, this would reload the dashboard with filtered data
    alert(`Filtering data from ${startDate} to ${endDate}`);

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('dateRangeModal'));
    modal.hide();

    // Refresh charts with new data
    location.reload();
}

function exportReport() {
    // In a real application, this would generate and download a report
    alert('Report export feature would generate PDF/Excel files with current data');
}

function viewInventoryDetails() {
    window.location.href = '/inventory';
}

// Real-time update functions
function updateRealTimeData() {
    // Simulate real-time data updates
    updateAppointmentTrends();
    updatePatientVisits();
    updateInventoryStatus();
}

function updateAppointmentTrends() {
    if (appointmentTrendsChart) {
        // Simulate new appointment data
        const newData = appointmentTrendsChart.data.datasets[0].data.map(value => 
            Math.max(0, value + Math.floor(Math.random() * 3) - 1)
        );
        appointmentTrendsChart.data.datasets[0].data = newData;
        appointmentTrendsChart.update('none');

        // Update stats
        const todaysBookings = newData.reduce((a, b) => a + b, 0);
        const todaysBookingsElement = document.getElementById('todaysBookings');
        if (todaysBookingsElement) {
            todaysBookingsElement.textContent = todaysBookings;
        }
    }
}

function updatePatientVisits() {
    if (patientVisitsChart) {
        const currentHour = new Date().getHours();
        const visitData = patientVisitsChart.data.datasets[0].data;

        // Simulate a new visit
        if (Math.random() > 0.7) {
            const currentVisits = parseInt(document.getElementById('visitCounter').textContent);
            const newVisits = currentVisits + 1;
            document.getElementById('visitCounter').textContent = newVisits;

            // Update progress
            const percentage = Math.min(100, (newVisits / 15) * 100);
            document.getElementById('visitProgress').style.width = percentage + '%';
            document.getElementById('visitPercentage').textContent = Math.round(percentage) + '%';

            // Update chart
            const hourIndex = Math.min(5, Math.floor((currentHour - 8) / 2));
            if (hourIndex >= 0 && hourIndex < visitData.length) {
                visitData[hourIndex] = Math.min(6, visitData[hourIndex] + 1);
                patientVisitsChart.update('none');
            }
        }
    }
}

function updateInventoryStatus() {
    // Simulate inventory usage updates
    const inventoryItems = [
        { name: 'Dental Gloves', current: 25, max: 100, element: null },
        { name: 'Anesthesia', current: 80, max: 100, element: null },
        { name: 'X-ray Films', current: 10, max: 100, element: null }
    ];

    // Randomly decrease inventory levels
    inventoryItems.forEach((item, index) => {
        if (Math.random() > 0.8) {
            item.current = Math.max(0, item.current - 1);
        }
    });
}

// Real-time updates
function updateRealTimeStats() {
    fetch('/api/realtime-stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);

            // Update appointment trends
            const trendsContainer = document.getElementById('appointment-trends');
            if (data.appointment_trends && trendsContainer) {
                let trendsHtml = '<h6 class="mb-3">Last 7 Days Appointments</h6>';
                data.appointment_trends.forEach(trend => {
                    trendsHtml += `<div class="d-flex justify-content-between mb-2">
                        <small>${trend.day} (${trend.date})</small>
                        <span class="badge bg-primary">${trend.count}</span>
                    </div>`;
                });
                trendsContainer.innerHTML = trendsHtml;
            }

            // Update today's visits
            const visitsElement = document.getElementById('today-visits');
            if (visitsElement && data.today_visits !== undefined) {
                visitsElement.textContent = data.today_visits;
            }

            // Update inventory usage
            const inventoryContainer = document.getElementById('inventory-usage');
            if (data.inventory_usage && inventoryContainer) {
                let inventoryHtml = '<h6 class="mb-3">Top Inventory Items</h6>';
                data.inventory_usage.slice(0, 5).forEach(item => {
                    const alertClass = item.is_low_stock ? 'danger' : (item.usage_percentage > 50 ? 'warning' : 'success');
                    inventoryHtml += `<div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="d-block">${item.name}</small>
                            <small class="text-muted">${item.category}</small>
                        </div>
                        <span class="badge bg-${alertClass}" title="Current: ${item.current_stock}, Min: ${item.minimum_stock}">
                            ${item.current_stock}
                        </span>
                    </div>`;
                });
                inventoryContainer.innerHTML = inventoryHtml;
            }

            // Update dashboard stats if available
            if (data.stats) {
                const todayAppointments = document.getElementById('todays-appointments');
                if (todayAppointments && data.stats.todays_appointments !== undefined) {
                    todayAppointments.textContent = data.stats.todays_appointments;
                }
            }
        })
        .catch(error => {
            console.error('Error updating real-time stats:', error);
            // Show error in containers
            const trendsContainer = document.getElementById('appointment-trends');
            const inventoryContainer = document.getElementById('inventory-usage');

            if (trendsContainer) {
                trendsContainer.innerHTML = '<div class="text-muted">Unable to load appointment trends</div>';
            }
            if (inventoryContainer) {
                inventoryContainer.innerHTML = '<div class="text-muted">Unable to load inventory data</div>';
            }
        });
}

// Auto-refresh every 30 seconds
setInterval(updateRealTimeData, 30000);
setInterval(updateRealTimeStats, 30000);

// Add visual indicators for live updates
function addLiveIndicators() {
    const liveElements = document.querySelectorAll('.badge:contains("LIVE")');
    liveElements.forEach(element => {
        setInterval(() => {
            element.style.opacity = '0.5';
            setTimeout(() => {
                element.style.opacity = '1';
            }, 500);
        }, 2000);
    });
}

// Set default date range to current month
document.addEventListener('DOMContentLoaded', function() {
    setDateRange('month');
    addLiveIndicators();

    // Start real-time updates after 5 seconds
    setTimeout(() => {
        updateRealTimeData();
        updateRealTimeStats();
    }, 5000);
});
</script>
{% endblock %}